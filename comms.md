# Comms spec

Commands are consistently traceable to their origin.

Responses are consistently traceable to their command.

## Commands

Commands may be issued by a client, or by the extension-background.

### Client-issued commands

Commands are issued by clients in the format

```typescript
{
    sequence: number;
    action: string;
    data?: object
}
```

- `sequence` is an identifier unique to the lifecycle of the client
  - the pair `(sequence, client)` must be unique over the lifecycle of the server
  - the `sequence` values generated by clients must be monotonically-increasing
  - `sequence` must be greater than or equal to `1`, and must be representable by a signed 32-bit integer
- `action` identifies the action to be executed
- `data` provides any required argument to the action
  - if `data` is non-null, but the action requires no data, the value is ignored

If client continuously generates 10 commands per second, its sequence will overflow in approximately 6.8 years. This is not seen as a practical issue.

### Internal representation

At all levels other than the client, commands are represented as

```typescript
{
    client: number;
    sequence: number;
    action: string;
    data?: object;
}
```

`client` is an identifier which is issued to a client on connection to the server
- at any point in time, each client must be uniquely identifiable by this number
- the value of `client` should not be considered secret
- client identifiers must be greater than or equal to `1`

The `client` and `sequence` values must remain immutable as the command is passed and executed.

### Background-issued commands

The background may issue commands using the reserved client identifier `0`. This is typically done to prompt the content tab to re-evaluate its state.

Where processing a command would result in a state change, the content page may effectively issue a command to itself using the reserved client identifier `0`.

## Responses

Responses represent the result of commands. Responses are transmitted to the issuing client.

The reserved client identifier `0` indicates that the command was generated internal to the system and not by a client. Responses to such a command are considered "broadcast" responses, and are transmitted to every active client.

### Internal representation

Responses are represented at all levels other than the client as the type `CommandResponse` defined as follows:

```typescript
interface ResponseBase {
    client: number;
    sequence: number;
    action: string;
}
interface OkResponse extends ResponseBase {
    outcome: "OK";
    data?: object;
}
interface FailedResponse extends ResponseBase {
    outcome: "Failed";
    reason: string;
}
interface ErrorResponse extends ResponseBase {
    outcome: "Error";
    message: string;
}
type CommandResponse = OkResponse|FailedResponse|ErrorResponse;
```

where `client`, `sequence`, and `action` are all defined as per the *Command* section above.

- `"Ok"` indicates that the command was successfully processed; `data` represents the result of the command if any
- `"Failed"` indicates that the command was unable to be processed, for example if it were incorrectly formed, if its data were invalid, or if it were an invalid operation given the current state
- `"Error"` indicates that some unexpected error occured while attempting to process the command

### Client representation

Responses are transmitted back the issuing client. If executing the command results in a state change, that state is broadcasted separately.

The response format is generally the same as that for the *Internal representation*, with two exceptions

- the `client` identifier may be transmitted, but should not be expected
- if the response is a broadcast response, the `sequence` identifer will be set to the reserved sequence identifier `0`, which signifies to the client that the response does not correspond to any command issued by that client.
