# Comms spec

Commands are consistently traceable to their origin.

Responses are consistently traceable to their command.

## Commands

Commands may be issued by a client, or by the extension-background.

### Client-issued commands

Commands are issued by clients in the format

```typescript
{
    sequence: number;
    action: string;
    data?: object
}
```

- `sequence` is an identifier unique to the lifecycle of the client
  - the pair `(sequence, client)` must be unique over the lifecycle of the server
  - the `sequence` values generated by clients must be monotonically-increasing
  - `sequence` must be greater than or equal to `1`, and must be representable by a signed 32-bit integer
- `action` identifies the action to be executed
- `data` provides any required argument to the action
  - if `data` is non-null, but the action requires no data, the value is ignored

If client continuously generates 10 commands per second, its sequence will overflow in approximately 6.8 years. This is not seen as a practical issue.

### Internal representation

At all levels other than the client, commands are represented as

```typescript
{
    client: number;
    sequence: number;
    action: string;
    data?: object;
}
```

`client` is an identifier which is issued to a client on connection to the server
- at any point in time, each client must be uniquely identifiable by this number
- the value of `client` should not be considered secret
- client identifiers must be greater than or equal to `1`

The `client` and `sequence` values must remain immutable as the command is passed and executed.

### Background-issued commands

The background may issue commands using the reserved client identifier `0`. This is typically done to prompt the content tab to re-evaluate its state.

Where processing a command would result in a state change, the content page may effectively issue a command to itself using the reserved client identifier `0`.

## Responses

Responses represent the result of commands. Responses are transmitted to the issuing client.

The reserved client identifier `0` indicates that the command was generated internal to the system and not by a client. Responses to such a command are considered "broadcast" responses, and are transmitted to every active client.

### Internal representation

Responses are represented at all levels other than the client as the type `CommandResponse` defined as follows:

```typescript
interface ResponseBase {
    client: number;
    sequence: number;
    action: string;
}
interface OkResponse extends ResponseBase {
    outcome: "OK";
    data?: object;
}
interface FailedResponse extends ResponseBase {
    outcome: "Failed";
    reason: string;
}
interface ErrorResponse extends ResponseBase {
    outcome: "Error";
    message: string;
}
type CommandResponse = OkResponse|FailedResponse|ErrorResponse;
```

where `client`, `sequence`, and `action` are all defined as per the *Command* section above.

- `"Ok"` indicates that the command was successfully processed; `data` represents the result of the command if any
- `"Failed"` indicates that the command was unable to be processed, for example if it were incorrectly formed, if its data were invalid, or if it were an invalid operation given the current state
- `"Error"` indicates that some unexpected error occured while attempting to process the command

### Client representation

Responses are transmitted back the issuing client. If executing the command results in a state change, that state is broadcasted separately.

The response format is generally the same as that for the *Internal representation*, with two exceptions

- the `client` identifier may be transmitted, but should not be expected
- if the response is a broadcast response, the `sequence` identifer will be set to the reserved sequence identifier `0`, which signifies to the client that the response does not correspond to any command issued by that client.

## Available commands

Use-cases:

1. select "Mr Fluffy The Cat" from the profile-select screen (`sel "Mr Fluffy The Cat"`)
   - *TODO: what about auto-selecting it?*
1. d-pad movement (`nav up`, `nav right`)
1. expose "my list" (`jump "my list"`)
1. play the thing that's currently highlighed (`sel`)
1. "enter" the highlighted thing (`jump "thing"`, `nav in`)
1. go to the "episodes" tab (`sel "episodes"`)
1. drop the "season" drop-down (`sel "season"`)
1. pick season 3 (`sel "season 3"`)
1. scroll sideways past the edge of a multi-page horizontal list (keep hitting `nav right`)
1. stop loading the page (`cancel`)
1. reload the page (`reload`)

### Session management

`browse`

Launches the system's web browser

`close`

Closes the active tab or browser window

`cancel`

Hits the ESC key

`reload`

Hits the F5 key

### Navigation

Navigation commands are always acknowledged. If they mutate the state, the state change
is broadcast separately.

*TODO: can we nack if the page is loading?*

`nav: up|down|left|right|in|out`

Navigates in a direction. The host may interpret relative movement
depending on the current state.


`sel: [identifier?]`

Activates the identified object if sepecified, or otherwise the current selection.
Morally-equivalent to mouse left-click.

`jump: [identifier]`

Moves the selection to the element corresponding to the identifier.

### Querying commands

`info: [identifier?]`

Provides "contents" information on the identified object or current selection. For example,
exposing a "react-ish" dropdown. Does not ack/nack until the host-state is ready. Mutates state.

`state`

Requests the current state. Does not ack/nack until the host page is ready to provide state, if loading.

### Mouse

Mouse controls provided as a general fallback/workaround if the state-management part doesn't
handle a particular use-case.

`mmov: [delta_x], [delta_y]`

Moves the mouse by the specified offset

`mset: [x], [y]`

Moves the mouse to the specified location

`click: left|right`

Clicks the specified button

`wheel: up|down [clicks=1]`

Moves the mouse-wheel by the specified amount of clicks in the selected direction

### Playback

`pause`

`play`

`skip: [sec=+10]`

*TODO: chapters?*